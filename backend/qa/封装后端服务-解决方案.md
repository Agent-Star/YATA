# YATA Backend Systemd Service 配置方案

## 一、Service 文件说明

已创建 `yata-backend.service` 文件，配置说明如下：

### 配置项解释

- **Description**: 服务描述
- **After**: 指定在网络服务启动后再启动该服务
- **Type=simple**: 简单服务类型，进程会持续运行
- **User=%i**: 使用当前用户身份运行服务
- **WorkingDirectory**: 设置工作目录为 `~/YATA/backend`
- **Environment**: 配置 PATH 环境变量，确保使用虚拟环境中的 Python
- **ExecStart**: 使用虚拟环境中的 Python 直接运行服务脚本
- **Restart=on-failure**: 服务失败时自动重启
- **RestartSec=5s**: 重启前等待 5 秒
- **StandardOutput/StandardError**: 将输出和错误日志记录到 systemd journal

## 二、安装步骤

### 1. 复制 service 文件到 systemd 目录

```bash
# 复制到用户级 systemd 目录（推荐）
mkdir -p ~/.config/systemd/user/
cp ~/YATA/backend/services/yata-backend.service ~/.config/systemd/user/
```

**或者** 使用系统级服务（需要 sudo 权限）：

```bash
# 复制到系统级 systemd 目录
sudo cp ~/YATA/backend/services/yata-backend.service /etc/systemd/system/
```

### 2. 重新加载 systemd 配置

**用户级服务：**

```bash
systemctl --user daemon-reload
```

**系统级服务：**

```bash
sudo systemctl daemon-reload
```

### 3. 启用开机自启

**用户级服务：**

```bash
systemctl --user enable yata-backend.service
```

**系统级服务：**

```bash
sudo systemctl enable yata-backend.service
```

### 4. 启动服务

**用户级服务：**

```bash
systemctl --user start yata-backend.service
```

**系统级服务：**

```bash
sudo systemctl start yata-backend.service
```

## 三、常用管理命令

### 查看服务状态

```bash
# 用户级
systemctl --user status yata-backend.service

# 系统级
sudo systemctl status yata-backend.service
```

### 停止服务

```bash
# 用户级
systemctl --user stop yata-backend.service

# 系统级
sudo systemctl stop yata-backend.service
```

### 重启服务

```bash
# 用户级
systemctl --user restart yata-backend.service

# 系统级
sudo systemctl restart yata-backend.service
```

### 查看服务日志

```bash
# 用户级
journalctl --user -u yata-backend.service -f

# 系统级
sudo journalctl -u yata-backend.service -f
```

### 禁用开机自启

```bash
# 用户级
systemctl --user disable yata-backend.service

# 系统级
sudo systemctl disable yata-backend.service
```

## 四、推荐使用方案

### 推荐：用户级服务

**优点：**

- 不需要 sudo 权限
- 更安全，服务以当前用户身份运行
- 适合个人开发环境
- 配置文件位于用户目录，更容易管理

**完整安装流程：**

```bash
# 1. 创建用户级 systemd 目录
mkdir -p ~/.config/systemd/user/

# 2. 复制 service 文件
cp ~/YATA/backend/services/yata-backend.service ~/.config/systemd/user/

# 3. 重新加载配置
systemctl --user daemon-reload

# 4. 启用开机自启
systemctl --user enable yata-backend.service

# 5. 启动服务
systemctl --user start yata-backend.service

# 6. 检查服务状态
systemctl --user status yata-backend.service
```

## 五、注意事项

1. **确保虚拟环境已创建**: 在运行服务前，确保已在 `~/YATA/backend` 目录下运行过 `uv venv` 和 `uv sync --frozen`

2. **检查路径**: 确保 `~/YATA/backend` 路径正确，如果项目在其他位置，需要修改 service 文件中的路径

3. **用户级服务开机自启**: 如果使用用户级服务，需要确保用户登录后服务才会启动。如果需要在用户未登录时就启动服务，应使用系统级服务

4. **环境变量**: 如果项目需要其他环境变量（如 API KEY），可以在 service 文件的 `[Service]` 部分添加：

   ```ini
   Environment="ENV_VAR_NAME=value"
   ```

   或者使用 EnvironmentFile 指定 .env 文件：

   ```ini
   EnvironmentFile=%h/YATA/backend/.env
   ```

5. **端口冲突**: 确保服务使用的端口（默认可能是 8000）没有被其他程序占用

## 六、故障排查

### 服务无法启动

```bash
# 查看详细日志
journalctl --user -u yata-backend.service -n 50 --no-pager

# 检查服务配置是否正确
systemctl --user cat yata-backend.service
```

### 重新加载修改后的 service 文件

```bash
systemctl --user daemon-reload
systemctl --user restart yata-backend.service
```

### 测试手动运行

```bash
cd ~/YATA/backend
source ./.venv/bin/activate
python src/service/service.py
```
