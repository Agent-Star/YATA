# 系统级服务配置说明（适用于 AWS EC2 等服务器环境）

## 问题说明

使用 `yata-backend.service` 和 `yata-tiny-frontend.service` 作为系统级服务时会报错：

```
Invalid user/group name or numeric ID
```

**原因**: 这两个文件中使用了 `User=%i` 和 `%h` 等变量，这些变量只在**用户级服务**中有效。系统级服务需要明确指定用户名和路径。

## 解决方案

### 方案一：使用专门的系统级服务文件（推荐）

我已经创建了专门的系统级服务配置文件：

- `services/yata-backend-system.service`
- `services/yata-tiny-frontend-system.service`

#### 1. 修改配置文件中的用户名和路径

根据你的实际情况修改服务文件：

**对于 AWS EC2 Ubuntu 实例：**

```bash
# 1. 编辑后端服务文件
sudo nano ~/YATA/backend/services/yata-backend-system.service

# 确认或修改以下内容：
# User=ubuntu
# WorkingDirectory=/home/ubuntu/YATA/backend
# Environment="PATH=/home/ubuntu/YATA/backend/.venv/bin:..."
# ExecStart=/home/ubuntu/YATA/backend/.venv/bin/python src/service/service.py
```

**对于 AWS EC2 Amazon Linux 实例：**

将 `User=ubuntu` 改为 `User=ec2-user`，路径改为 `/home/ec2-user/YATA/backend`

**对于其他用户名或路径：**

运行以下命令查看当前用户名和主目录：

```bash
whoami  # 显示当前用户名
echo $HOME  # 显示主目录路径
pwd  # 显示当前目录
```

然后在 service 文件中相应修改。

#### 2. 安装系统级服务

```bash
# 复制到系统目录
sudo cp ~/YATA/backend/services/yata-backend-system.service /etc/systemd/system/yata-backend.service
sudo cp ~/YATA/backend/services/yata-tiny-frontend-system.service /etc/systemd/system/yata-tiny-frontend.service

# 重新加载配置
sudo systemctl daemon-reload

# 启用开机自启
sudo systemctl enable yata-backend.service
sudo systemctl enable yata-tiny-frontend.service

# 启动服务
sudo systemctl start yata-backend.service
sudo systemctl start yata-tiny-frontend.service

# 检查服务状态
sudo systemctl status yata-backend.service
sudo systemctl status yata-tiny-frontend.service
```

### 方案二：使用用户级服务（更简单）

**优点：**

- 不需要修改配置文件
- 不需要 sudo 权限
- 自动使用当前用户身份

**安装步骤：**

```bash
# 1. 创建用户级 systemd 目录
mkdir -p ~/.config/systemd/user/

# 2. 复制服务文件（使用原始的用户级服务文件）
cp ~/YATA/backend/services/yata-backend.service ~/.config/systemd/user/
cp ~/YATA/backend/services/yata-tiny-frontend.service ~/.config/systemd/user/

# 3. 重新加载配置
systemctl --user daemon-reload

# 4. 启用开机自启（需要启用 linger）
sudo loginctl enable-linger $USER
systemctl --user enable yata-backend.service
systemctl --user enable yata-tiny-frontend.service

# 5. 启动服务
systemctl --user start yata-backend.service
systemctl --user start yata-tiny-frontend.service

# 6. 检查服务状态
systemctl --user status yata-backend.service
systemctl --user status yata-tiny-frontend.service
```

**注意**: `sudo loginctl enable-linger $USER` 允许用户服务在用户未登录时继续运行，这对于服务器环境很重要。

## 常用管理命令

### 系统级服务

```bash
# 查看状态
sudo systemctl status yata-backend.service

# 查看日志
sudo journalctl -u yata-backend.service -f

# 重启服务
sudo systemctl restart yata-backend.service

# 停止服务
sudo systemctl stop yata-backend.service

# 禁用开机自启
sudo systemctl disable yata-backend.service
```

### 用户级服务

```bash
# 查看状态
systemctl --user status yata-backend.service

# 查看日志
journalctl --user -u yata-backend.service -f

# 重启服务
systemctl --user restart yata-backend.service

# 停止服务
systemctl --user stop yata-backend.service

# 禁用开机自启
systemctl --user disable yata-backend.service
```

## AWS EC2 防火墙配置

如果需要从外部访问服务，需要配置安全组：

### 1. 在 AWS 控制台配置安全组

**后端服务（FastAPI）**:

- 类型: Custom TCP
- 端口: 8000
- 源: 根据需求选择（0.0.0.0/0 允许所有，或指定 IP）

**前端服务（Streamlit）**:

- 类型: Custom TCP
- 端口: 8501
- 源: 根据需求选择（0.0.0.0/0 允许所有，或指定 IP）

### 2. 在 EC2 实例上配置防火墙（如果使用 ufw）

```bash
# 允许后端端口
sudo ufw allow 8000/tcp

# 允许前端端口
sudo ufw allow 8501/tcp

# 查看状态
sudo ufw status
```

## 故障排查

### 1. 查看详细错误信息

```bash
# 系统级
sudo journalctl -u yata-backend.service -n 50 --no-pager

# 用户级
journalctl --user -u yata-backend.service -n 50 --no-pager
```

### 2. 检查服务配置

```bash
# 系统级
sudo systemctl cat yata-backend.service

# 用户级
systemctl --user cat yata-backend.service
```

### 3. 测试手动运行

```bash
cd ~/YATA/backend
source ./.venv/bin/activate
python src/service/service.py
```

### 4. 检查文件权限

```bash
# 确保服务文件可读
ls -la /etc/systemd/system/yata-*.service

# 确保项目目录可访问
ls -la ~/YATA/backend/
```

### 5. 常见错误及解决方法

**错误**: `Invalid user/group name or numeric ID`

- **原因**: 使用了用户级服务文件作为系统级服务
- **解决**: 使用 `*-system.service` 文件或改用用户级服务

**错误**: `Failed to start ... No such file or directory`

- **原因**: WorkingDirectory 或 ExecStart 路径不正确
- **解决**: 检查并修改 service 文件中的路径

**错误**: `Permission denied`

- **原因**: 服务用户没有访问项目目录的权限
- **解决**: 检查目录权限，或修改 User 为项目所有者

## 推荐方案对比

| 特性 | 用户级服务 | 系统级服务 |
|-----|----------|----------|
| 需要 sudo | 否 | 是 |
| 配置复杂度 | 低（自动变量） | 中（需要指定路径） |
| 开机自启 | 需要 enable-linger | 原生支持 |
| 权限隔离 | 更好 | 一般 |
| 适用场景 | 个人开发/单用户 | 多用户/生产环境 |

**对于 AWS EC2 个人项目，推荐使用方案二（用户级服务）**，配置更简单且更安全。
