# YATA Tiny Frontend Systemd Service 配置方案

## 一、Service 文件说明

已创建 `yata-tiny-frontend.service` 文件，配置说明如下：

### 配置项解释

- **Description**: 服务描述，标识这是 Streamlit 简易前端服务
- **After**: 指定在网络服务启动后再启动该服务
- **Type=simple**: 简单服务类型，进程会持续运行
- **User=%i**: 使用当前用户身份运行服务
- **WorkingDirectory**: 设置工作目录为 `~/YATA/backend`
- **Environment**: 配置 PATH 环境变量，确保使用虚拟环境中的 streamlit
- **ExecStart**: 使用虚拟环境中的 streamlit 运行应用
  - `--server.headless=true`: 以无头模式运行，适合后台服务
- **Restart=on-failure**: 服务失败时自动重启
- **RestartSec=5s**: 重启前等待 5 秒
- **StandardOutput/StandardError**: 将输出和错误日志记录到 systemd journal

## 二、安装步骤

### 1. 复制 service 文件到 systemd 目录

```bash
# 复制到用户级 systemd 目录（推荐）
mkdir -p ~/.config/systemd/user/
cp ~/YATA/backend/services/yata-tiny-frontend.service ~/.config/systemd/user/
```

**或者** 使用系统级服务（需要 sudo 权限）：

```bash
# 复制到系统级 systemd 目录
sudo cp ~/YATA/backend/services/yata-tiny-frontend.service /etc/systemd/system/
```

### 2. 重新加载 systemd 配置

**用户级服务：**

```bash
systemctl --user daemon-reload
```

**系统级服务：**

```bash
sudo systemctl daemon-reload
```

### 3. 启用开机自启

**用户级服务：**

```bash
systemctl --user enable yata-tiny-frontend.service
```

**系统级服务：**

```bash
sudo systemctl enable yata-tiny-frontend.service
```

### 4. 启动服务

**用户级服务：**

```bash
systemctl --user start yata-tiny-frontend.service
```

**系统级服务：**

```bash
sudo systemctl start yata-tiny-frontend.service
```

## 三、常用管理命令

### 查看服务状态

```bash
# 用户级
systemctl --user status yata-tiny-frontend.service

# 系统级
sudo systemctl status yata-tiny-frontend.service
```

### 停止服务

```bash
# 用户级
systemctl --user stop yata-tiny-frontend.service

# 系统级
sudo systemctl stop yata-tiny-frontend.service
```

### 重启服务

```bash
# 用户级
systemctl --user restart yata-tiny-frontend.service

# 系统级
sudo systemctl restart yata-tiny-frontend.service
```

### 查看服务日志

```bash
# 用户级
journalctl --user -u yata-tiny-frontend.service -f

# 系统级
sudo journalctl -u yata-tiny-frontend.service -f
```

### 禁用开机自启

```bash
# 用户级
systemctl --user disable yata-tiny-frontend.service

# 系统级
sudo systemctl disable yata-tiny-frontend.service
```

## 四、推荐使用方案

### 推荐：用户级服务

**优点：**

- 不需要 sudo 权限
- 更安全，服务以当前用户身份运行
- 适合个人开发环境
- 配置文件位于用户目录，更容易管理

**完整安装流程：**

```bash
# 1. 创建用户级 systemd 目录
mkdir -p ~/.config/systemd/user/

# 2. 复制 service 文件
cp ~/YATA/backend/services/yata-tiny-frontend.service ~/.config/systemd/user/

# 3. 重新加载配置
systemctl --user daemon-reload

# 4. 启用开机自启
systemctl --user enable yata-tiny-frontend.service

# 5. 启动服务
systemctl --user start yata-tiny-frontend.service

# 6. 检查服务状态
systemctl --user status yata-tiny-frontend.service
```

## 五、Streamlit 特定配置

### 1. 访问前端界面

默认情况下，Streamlit 会在 `http://localhost:8501` 上运行。

你可以在浏览器中访问：

```txt
http://localhost:8501
```

### 2. 自定义 Streamlit 配置

如果需要修改端口或其他配置，可以创建 Streamlit 配置文件：

```bash
mkdir -p ~/.streamlit
```

创建 `~/.streamlit/config.toml` 文件：

```toml
[server]
port = 8501
address = "0.0.0.0"
headless = true

[browser]
serverAddress = "localhost"
gatherUsageStats = false
```

或者直接在 service 文件的 ExecStart 命令中添加参数：

```ini
ExecStart=%h/YATA/backend/.venv/bin/streamlit run src/streamlit_app.py --server.headless=true --server.port=8501 --server.address=0.0.0.0
```

### 3. 允许外网访问（可选）

如果需要从其他机器访问 Streamlit，修改 service 文件：

```ini
ExecStart=%h/YATA/backend/.venv/bin/streamlit run src/streamlit_app.py --server.headless=true --server.address=0.0.0.0
```

然后确保防火墙允许 8501 端口：

```bash
# 如果使用 ufw
sudo ufw allow 8501/tcp
```

## 六、注意事项

1. **确保虚拟环境已创建**: 在运行服务前，确保已在 `~/YATA/backend` 目录下运行过 `uv venv` 和 `uv sync --frozen`

2. **检查路径**: 确保 `~/YATA/backend` 路径正确，如果项目在其他位置，需要修改 service 文件中的路径

3. **用户级服务开机自启**: 如果使用用户级服务，需要确保用户登录后服务才会启动。如果需要在用户未登录时就启动服务，应使用系统级服务

4. **环境变量**: Streamlit 应用需要后端 API 的地址等环境变量，可以在 service 文件的 `[Service]` 部分添加：

   ```ini
   Environment="API_URL=http://localhost:8000"
   ```

   或者使用 EnvironmentFile 指定 .env 文件：

   ```ini
   EnvironmentFile=%h/YATA/backend/.env
   ```

5. **端口冲突**:
   - Streamlit 默认使用 **8501** 端口
   - 后端服务默认使用 **8000** 端口
   - 确保这两个端口都没有被占用

6. **依赖关系**: 如果 Streamlit 前端依赖后端服务，可以在 service 文件中添加依赖：

   ```ini
   [Unit]
   Description=YATA Tiny Frontend Service (Streamlit)
   After=network.target yata-backend.service
   Requires=yata-backend.service
   ```

   这样会确保后端服务先启动，并且如果后端服务停止，前端也会停止。

## 七、故障排查

### 服务无法启动

```bash
# 查看详细日志
journalctl --user -u yata-tiny-frontend.service -n 50 --no-pager

# 检查服务配置是否正确
systemctl --user cat yata-tiny-frontend.service
```

### 重新加载修改后的 service 文件

```bash
systemctl --user daemon-reload
systemctl --user restart yata-tiny-frontend.service
```

### 测试手动运行

```bash
cd ~/YATA/backend
source ./.venv/bin/activate
streamlit run src/streamlit_app.py
```

### 检查端口占用

```bash
# 检查 8501 端口是否被占用
sudo netstat -tlnp | grep 8501
# 或者
sudo ss -tlnp | grep 8501
```

### 无法访问前端界面

1. 检查服务是否正常运行：

   ```bash
   systemctl --user status yata-tiny-frontend.service
   ```

2. 检查防火墙设置（如果需要外网访问）

3. 查看日志确认 Streamlit 监听的地址和端口：

   ```bash
   journalctl --user -u yata-tiny-frontend.service -n 20
   ```

## 八、同时管理前后端服务

### 一键启动所有服务

```bash
systemctl --user start yata-backend.service yata-tiny-frontend.service
```

### 一键停止所有服务

```bash
systemctl --user stop yata-backend.service yata-tiny-frontend.service
```

### 一键重启所有服务

```bash
systemctl --user restart yata-backend.service yata-tiny-frontend.service
```

### 查看所有 YATA 服务状态

```bash
systemctl --user status 'yata-*'
```

### 同时查看所有服务日志

```bash
journalctl --user -u yata-backend.service -u yata-tiny-frontend.service -f
```
