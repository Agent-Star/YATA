# è®¤è¯æ–¹æ¡ˆæŠ€æœ¯æˆæœ¬å¯¹æ¯”åˆ†æ

## ä¸€ã€å½“å‰å®ç° (é€‰é¡¹ A: Pure JWT Token)

### ç°æœ‰ä»£ç ç»“æ„

```python
# src/auth/auth.py (å½“å‰å®ç°)
from fastapi_users.authentication import BearerTransport

bearer_transport = BearerTransport(tokenUrl="auth/jwt/login")
auth_backend = AuthenticationBackend(
    name="jwt",
    transport=bearer_transport,
    get_strategy=get_jwt_strategy,
)
```

### å·¥ä½œæµç¨‹

1. ç”¨æˆ·ç™»å½• â†’ åç«¯è¿”å› `{"access_token": "...", "token_type": "bearer"}`
2. å‰ç«¯å­˜å‚¨ token (localStorage/sessionStorage)
3. æ¯æ¬¡è¯·æ±‚æºå¸¦ `Authorization: Bearer <token>`
4. åç«¯éªŒè¯ token

### ä¼˜ç‚¹

- âœ… **å·²å®Œå…¨å®ç°**, æ— éœ€ä»»ä½•æ”¹åŠ¨
- âœ… ä»£ç ç®€å•, ç»´æŠ¤æˆæœ¬ä½
- âœ… å‰ç«¯çµæ´»æ§åˆ¶ token ç”Ÿå‘½å‘¨æœŸ
- âœ… è·¨åŸŸå‹å¥½

### ç¼ºç‚¹

- âŒ Token å­˜å‚¨åœ¨ localStorage, æœ‰ XSS é£é™©
- âŒ å‰ç«¯éœ€è¦æ‰‹åŠ¨ç®¡ç† token (é™„åŠ åˆ°è¯·æ±‚å¤´)
- âŒ æ— æ³•è®¾ç½® HttpOnly (JavaScript å¯è®¿é—®)

---

## äºŒã€æ··åˆæ–¹æ¡ˆ (é€‰é¡¹ C: JWT in HttpOnly Cookie)

### éœ€è¦çš„æ”¹åŠ¨

#### 2.1 ä¿®æ”¹è®¤è¯ä¼ è¾“æ–¹å¼

**æ–‡ä»¶**: `src/auth/auth.py`

**æ”¹åŠ¨å‰**:

```python
from fastapi_users.authentication import BearerTransport

bearer_transport = BearerTransport(tokenUrl="auth/jwt/login")
```

**æ”¹åŠ¨å**:

```python
from fastapi_users.authentication import CookieTransport

cookie_transport = CookieTransport(
    cookie_name="yata_auth",           # Cookie åç§°
    cookie_max_age=3600 * 24 * 7,      # 7 å¤© (ä¸ JWT æœ‰æ•ˆæœŸä¸€è‡´)
    cookie_path="/",                   # Cookie ä½œç”¨è·¯å¾„
    cookie_domain=None,                # è‡ªåŠ¨ä½¿ç”¨å½“å‰åŸŸ
    cookie_secure=not settings.is_dev(),  # ç”Ÿäº§ç¯å¢ƒå¯ç”¨ HTTPS only
    cookie_httponly=True,              # âœ… é˜²æ­¢ JavaScript è®¿é—®
    cookie_samesite="lax",             # âœ… CSRF é˜²æŠ¤
)
```

**ä»£ç é‡**: çº¦ 10 è¡Œ (æ›¿æ¢ 2 è¡Œ)

#### 2.2 é…ç½® CORS (å¦‚æœå‰åç«¯åˆ†ç¦»)

**æ–‡ä»¶**: `src/service/service.py`

**æ–°å¢ä»£ç **:

```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:3000"],  # å‰ç«¯åœ°å€
    allow_credentials=True,                   # âœ… å…è®¸æºå¸¦ Cookie
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**ä»£ç é‡**: çº¦ 8 è¡Œ (æ–°å¢)

**æ³¨æ„**: å¦‚æœå‰ç«¯é€šè¿‡ Next.js ä»£ç†æˆ–åŒåŸŸéƒ¨ç½², æ­¤æ­¥éª¤å¯çœç•¥

#### 2.3 è°ƒæ•´ç™»å½•/ç™»å‡ºå“åº” (å¯é€‰ä¼˜åŒ–)

**å½“å‰è¡Œä¸º**:

- ç™»å½•: FastAPI-Users è‡ªåŠ¨è®¾ç½® Cookie, è¿”å› token (å†—ä½™)
- ç™»å‡º: è‡ªåŠ¨æ¸…é™¤ Cookie

**å¯é€‰ä¼˜åŒ–**:

```python
# ç™»å½•ååªè¿”å›ç”¨æˆ·ä¿¡æ¯, ä¸è¿”å› token (å› ä¸ºå·²åœ¨ Cookie ä¸­)
# éœ€è¦è‡ªå®šä¹‰ç™»å½•è·¯ç”±, çº¦ 20-30 è¡Œä»£ç 
```

**ä»£ç é‡**: 0 è¡Œ (ä½¿ç”¨é»˜è®¤) æˆ– 20-30 è¡Œ (è‡ªå®šä¹‰)

#### 2.4 ç¯å¢ƒå˜é‡é…ç½®

**æ–‡ä»¶**: `env.example` å’Œ `.env`

**æ–°å¢é…ç½®**:

```bash
# Cookie é…ç½®
AUTH_COOKIE_SECURE=true  # ç”Ÿäº§ç¯å¢ƒå¯ç”¨
AUTH_COOKIE_SAMESITE=lax
```

**ä»£ç é‡**: 2 è¡Œé…ç½®

### æ€»è®¡æ”¹åŠ¨é‡

| æ”¹åŠ¨é¡¹ | æ–‡ä»¶ | ä»£ç è¡Œæ•° | å¤æ‚åº¦ |
|--------|------|---------|--------|
| ä¿®æ”¹ Transport | `auth/auth.py` | ~10 è¡Œ | ğŸŸ¢ ç®€å• |
| é…ç½® CORS | `service/service.py` | ~8 è¡Œ | ğŸŸ¢ ç®€å• |
| ç¯å¢ƒå˜é‡ | `env.example` | ~2 è¡Œ | ğŸŸ¢ ç®€å• |
| **æ€»è®¡** | - | **~20 è¡Œ** | ğŸŸ¢ ç®€å• |

---

## ä¸‰ã€æŠ€æœ¯ç»„ä»¶å¯¹æ¯”

### éœ€è¦å¼•å…¥çš„æ–°ä¾èµ–

**é€‰é¡¹ A (å½“å‰ JWT)**: âœ… æ— éœ€æ–°ä¾èµ–

**é€‰é¡¹ C (æ··åˆæ–¹æ¡ˆ)**: âœ… **æ— éœ€æ–°ä¾èµ–**

- `CookieTransport` å·²åŒ…å«åœ¨ `fastapi-users` ä¸­
- CORS ä¸­é—´ä»¶å·²åŒ…å«åœ¨ `fastapi` ä¸­
- æ‰€æœ‰åŠŸèƒ½å‡ä½¿ç”¨ç°æœ‰åº“å®ç°

### æŠ€æœ¯é£é™©è¯„ä¼°

| é£é™©é¡¹ | é€‰é¡¹ A (JWT) | é€‰é¡¹ C (Cookie) |
|--------|-------------|-----------------|
| XSS æ”»å‡» | ğŸ”´ é«˜ (token å¯è¢«çªƒå–) | ğŸŸ¢ ä½ (HttpOnly ä¿æŠ¤) |
| CSRF æ”»å‡» | ğŸŸ¢ ä½ (æ— çŠ¶æ€) | ğŸŸ¡ ä¸­ (éœ€ SameSite é…ç½®) |
| è·¨åŸŸå¤æ‚åº¦ | ğŸŸ¢ ä½ | ğŸŸ¡ ä¸­ (éœ€é…ç½® credentials) |
| æµè§ˆå™¨å…¼å®¹æ€§ | ğŸŸ¢ é«˜ | ğŸŸ¢ é«˜ |
| ç§»åŠ¨ç«¯å…¼å®¹æ€§ | ğŸŸ¢ é«˜ | ğŸŸ¡ ä¸­ (éœ€å¤„ç† Cookie) |

---

## å››ã€å‰ç«¯é€‚é…æˆæœ¬

### é€‰é¡¹ A: å½“å‰ JWT æ–¹æ¡ˆ

**å‰ç«¯éœ€è¦**:

```typescript
// ç™»å½•åæ‰‹åŠ¨å­˜å‚¨ token
const { access_token } = await response.json();
localStorage.setItem('token', access_token);

// æ¯æ¬¡è¯·æ±‚æ‰‹åŠ¨é™„åŠ 
headers: {
  'Authorization': `Bearer ${localStorage.getItem('token')}`
}
```

**å·¥ä½œé‡**: éœ€è¦å‰ç«¯å®ç° token ç®¡ç†é€»è¾‘

### é€‰é¡¹ C: æ··åˆæ–¹æ¡ˆ

**å‰ç«¯éœ€è¦**:

```typescript
// ç™»å½•åæ— éœ€æ‰‹åŠ¨å­˜å‚¨, Cookie è‡ªåŠ¨ç®¡ç†

// æ¯æ¬¡è¯·æ±‚åªéœ€
fetch(url, {
  credentials: 'include'  // è‡ªåŠ¨æºå¸¦ Cookie
})
```

**å·¥ä½œé‡**: âœ… å‡ ä¹ä¸º 0 (å‰ç«¯å·²é…ç½® `credentials: include`)

---

## äº”ã€å®æ–½å¤æ‚åº¦è¯„ä¼°

### é€‰é¡¹ A: ä¿æŒç°æœ‰ JWT æ–¹æ¡ˆ

| é¡¹ç›® | è¯„ä¼° |
|------|------|
| åç«¯æ”¹åŠ¨ | ğŸŸ¢ 0 è¡Œä»£ç  |
| å‰ç«¯æ”¹åŠ¨ | ğŸŸ¡ éœ€å®ç° token ç®¡ç† (~50 è¡Œ) |
| æµ‹è¯•å·¥ä½œé‡ | ğŸŸ¢ æ— éœ€é¢å¤–æµ‹è¯• |
| æ–‡æ¡£æ›´æ–° | ğŸŸ¢ æ— éœ€æ›´æ–° |
| **æ€»å¤æ‚åº¦** | ğŸŸ¢ **æä½** |

### é€‰é¡¹ C: æ··åˆæ–¹æ¡ˆ

| é¡¹ç›® | è¯„ä¼° |
|------|------|
| åç«¯æ”¹åŠ¨ | ğŸŸ¢ ~20 è¡Œä»£ç  (ç®€å•æ›¿æ¢) |
| å‰ç«¯æ”¹åŠ¨ | ğŸŸ¢ 0 è¡Œ (å·²å…¼å®¹) |
| æµ‹è¯•å·¥ä½œé‡ | ğŸŸ¡ éœ€æµ‹è¯• Cookie è®¾ç½® (~2 ä¸ªæµ‹è¯•ç”¨ä¾‹) |
| æ–‡æ¡£æ›´æ–° | ğŸŸ¡ éœ€æ›´æ–°è®¤è¯è¯´æ˜ |
| **æ€»å¤æ‚åº¦** | ğŸŸ¢ **ä½** |

---

## å…­ã€å®‰å…¨æ€§å¯¹æ¯”

### XSS æ”»å‡»åœºæ™¯

**åœºæ™¯**: æ¶æ„è„šæœ¬æ³¨å…¥åˆ°é¡µé¢ä¸­

**é€‰é¡¹ A (JWT in localStorage)**:

```javascript
// æ”»å‡»è€…å¯çªƒå– token
const stolenToken = localStorage.getItem('token');
sendToAttacker(stolenToken);
```

ğŸ”´ **é«˜é£é™©**: Token å®Œå…¨æš´éœ²ç»™ JavaScript

**é€‰é¡¹ C (JWT in HttpOnly Cookie)**:

```javascript
// æ”»å‡»è€…æ— æ³•è®¿é—® Cookie
document.cookie; // ä¸åŒ…å« HttpOnly Cookie
```

ğŸŸ¢ **ä½é£é™©**: Cookie å—æµè§ˆå™¨ä¿æŠ¤

### CSRF æ”»å‡»åœºæ™¯

**åœºæ™¯**: æ¶æ„ç½‘ç«™å‘èµ·è·¨ç«™è¯·æ±‚

**é€‰é¡¹ A (JWT in Header)**:

```html
<!-- æ”»å‡»è€…æ— æ³•æ„é€ å¸¦ Authorization Header çš„è¯·æ±‚ -->
```

ğŸŸ¢ **ä½é£é™©**: Header ä¸ä¼šè‡ªåŠ¨é™„åŠ 

**é€‰é¡¹ C (Cookie with SameSite)**:

```python
cookie_samesite="lax"  # é˜»æ­¢è·¨ç«™è¯·æ±‚è‡ªåŠ¨æºå¸¦ Cookie
```

ğŸŸ¢ **ä½é£é™©**: SameSite ä¿æŠ¤

---

## ä¸ƒã€æ¨èå†³ç­–

### åœºæ™¯ 1: ä¼˜å…ˆå¿«é€Ÿä¸Šçº¿

**æ¨è**: **é€‰é¡¹ A (ä¿æŒå½“å‰ JWT æ–¹æ¡ˆ)**

**ç†ç”±**:

- âœ… åç«¯é›¶æ”¹åŠ¨, ç«‹å³å¯ç”¨
- âœ… å®æ–½é£é™©ä¸º 0
- âš ï¸ å‰ç«¯éœ€è¦å®ç° token ç®¡ç† (çº¦ 1 å°æ—¶å·¥ä½œé‡)
- âš ï¸ å®‰å…¨æ€§ç¨ä½, ä½†å¯¹äºå†…éƒ¨/MVP é¡¹ç›®å¯æ¥å—

### åœºæ™¯ 2: æ³¨é‡å®‰å…¨æ€§ä¸ç”¨æˆ·ä½“éªŒ

**æ¨è**: **é€‰é¡¹ C (æ··åˆæ–¹æ¡ˆ)**

**ç†ç”±**:

- âœ… åç«¯æ”¹åŠ¨é‡æå° (~20 è¡Œ, 30 åˆ†é’Ÿå·¥ä½œé‡)
- âœ… å‰ç«¯é›¶æ”¹åŠ¨ (å·²å…¼å®¹)
- âœ… å®‰å…¨æ€§æ˜¾è‘—æå‡ (HttpOnly é˜² XSS)
- âœ… ç”¨æˆ·ä½“éªŒæ›´å¥½ (æ— éœ€å‰ç«¯ç®¡ç† token)
- âš ï¸ éœ€è¦é¢å¤–æµ‹è¯• Cookie è¡Œä¸º

### åœºæ™¯ 3: æœªæ¥éœ€è¦æ”¯æŒç§»åŠ¨ç«¯ APP

**æ¨è**: **é€‰é¡¹ A (ä¿æŒ JWT æ–¹æ¡ˆ)** æˆ– **åŒæ—¶æ”¯æŒä¸¤ç§æ–¹å¼**

**ç†ç”±**:

- ç§»åŠ¨ç«¯åŸç”Ÿ APP ä¸­, Header æ–¹å¼æ›´é€šç”¨
- Cookie åœ¨æŸäº›ç§»åŠ¨ç«¯ç¯å¢ƒä¸‹å¤„ç†è¾ƒå¤æ‚
- å¯ä»¥åŒæ—¶ä¿ç•™ä¸¤ç§è®¤è¯åç«¯ (FastAPI-Users æ”¯æŒå¤šåç«¯)

---

## å…«ã€æ··åˆæ–¹æ¡ˆå®æ–½æ£€æŸ¥æ¸…å•

å¦‚æœé€‰æ‹©æ··åˆæ–¹æ¡ˆ, ä»¥ä¸‹æ˜¯å®Œæ•´çš„å®æ–½æ­¥éª¤:

### âœ… ä»£ç ä¿®æ”¹ (é¢„è®¡ 30 åˆ†é’Ÿ)

- [ ] ä¿®æ”¹ `src/auth/auth.py`: æ›¿æ¢ `BearerTransport` ä¸º `CookieTransport`
- [ ] é…ç½® Cookie å‚æ•° (name, max_age, httponly, samesite, secure)
- [ ] (å¯é€‰) é…ç½® CORS ä¸­é—´ä»¶ (å¦‚æœå‰åç«¯åˆ†ç¦»)
- [ ] æ›´æ–° `env.example` æ·»åŠ  Cookie é…ç½®è¯´æ˜

### âœ… æµ‹è¯•éªŒè¯ (é¢„è®¡ 30 åˆ†é’Ÿ)

- [ ] æµ‹è¯•æ³¨å†Œæµç¨‹: Cookie æ˜¯å¦æ­£ç¡®è®¾ç½®
- [ ] æµ‹è¯•ç™»å½•æµç¨‹: Cookie æ˜¯å¦æ­£ç¡®è®¾ç½®
- [ ] æµ‹è¯•ç™»å‡ºæµç¨‹: Cookie æ˜¯å¦æ­£ç¡®æ¸…é™¤
- [ ] æµ‹è¯•å—ä¿æŠ¤ç«¯ç‚¹: Cookie è®¤è¯æ˜¯å¦ç”Ÿæ•ˆ
- [ ] æµ‹è¯•æµè§ˆå™¨å¼€å‘è€…å·¥å…·: ç¡®è®¤ Cookie çš„ HttpOnly å’Œ Secure æ ‡å¿—

### âœ… æ–‡æ¡£æ›´æ–° (é¢„è®¡ 15 åˆ†é’Ÿ)

- [ ] æ›´æ–° `docs/Authentication.md`: è¯´æ˜ Cookie è®¤è¯æ–¹å¼
- [ ] æ›´æ–° `docs/Quick_Start_Auth.md`: æ›´æ–°ç¤ºä¾‹ (æ— éœ€æ‰‹åŠ¨ç®¡ç† token)
- [ ] æ›´æ–°æ¥å£å¯¹æ¥æ–‡æ¡£: è¯´æ˜å‰ç«¯åªéœ€ `credentials: include`

### âœ… æ€»è®¡: **çº¦ 1.5 å°æ—¶**

---

## ä¹ã€æœ€ç»ˆå»ºè®®

### æˆ‘çš„æ¨è: **é€‰é¡¹ C (æ··åˆæ–¹æ¡ˆ)**

**ç†ç”±æ€»ç»“**:

1. **å®æ–½æˆæœ¬æä½**: ä»…éœ€ä¿®æ”¹ ~20 è¡Œä»£ç , çº¦ 1.5 å°æ—¶å·¥ä½œé‡
2. **æ— éœ€æ–°ä¾èµ–**: æ‰€æœ‰åŠŸèƒ½å‡ä½¿ç”¨ç°æœ‰åº“
3. **å®‰å…¨æ€§æ˜¾è‘—æå‡**: HttpOnly Cookie æœ‰æ•ˆé˜²å¾¡ XSS
4. **ç”¨æˆ·ä½“éªŒæ›´å¥½**: å‰ç«¯æ— éœ€ç®¡ç† token
5. **å‰ç«¯é›¶æ”¹åŠ¨**: å·²å…¼å®¹ `credentials: include`
6. **ç¬¦åˆæœ€ä½³å®è·µ**: ä¸šç•Œä¸»æµæ–¹æ¡ˆ

**é£é™©**: ğŸŸ¢ ä½

- æ”¹åŠ¨é›†ä¸­åœ¨å•ä¸€æ–‡ä»¶
- ä½¿ç”¨æˆç†Ÿçš„ FastAPI-Users åŠŸèƒ½
- æµ‹è¯•è¦†ç›–ç®€å•

**å¯æ‰©å±•æ€§**: ğŸŸ¢ é«˜

- æœªæ¥å¯åŒæ—¶æ”¯æŒ Bearer Token (å¤šåç«¯)
- ä¸å½±å“ç°æœ‰å…¶ä»–åŠŸèƒ½

---

## åã€å¤‡é€‰æ–¹æ¡ˆ: åŒæ—¶æ”¯æŒä¸¤ç§è®¤è¯

å¦‚æœå¸Œæœ›**å‘åå…¼å®¹**æˆ–æ”¯æŒå¤šç§å®¢æˆ·ç«¯, FastAPI-Users æ”¯æŒé…ç½®å¤šä¸ªè®¤è¯åç«¯:

```python
# åŒæ—¶æ”¯æŒ Cookie å’Œ Bearer Token
cookie_transport = CookieTransport(...)
bearer_transport = BearerTransport(...)

cookie_backend = AuthenticationBackend(name="cookie", transport=cookie_transport, ...)
bearer_backend = AuthenticationBackend(name="bearer", transport=bearer_transport, ...)

fastapi_users = FastAPIUsers[User, str](
    get_user_manager,
    [cookie_backend, bearer_backend],  # ä¸¤ç§æ–¹å¼éƒ½æ”¯æŒ
)
```

**é¢å¤–æˆæœ¬**: +5 è¡Œä»£ç 

**æ”¶ç›Š**:

- Web å‰ç«¯ä½¿ç”¨ Cookie (æ›´å®‰å…¨)
- ç§»åŠ¨ç«¯/API å®¢æˆ·ç«¯ä½¿ç”¨ Bearer Token (æ›´çµæ´»)

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2025-10-27  
**çŠ¶æ€**: æŠ€æœ¯æˆæœ¬åˆ†æå®Œæˆ
