# 修复 NLU 严重卡死的 bug 并分析其他带来性能开销的潜在问题

## 约定

请你注意, 如果我要求你先对接下来的某些步骤进行规划, 那么请你将你的规划以 markdown 文件的格式输出到 @algorithms/NLU/docs/gen/ 中, 而且是分门别类的存放到对应的子文件夹中 (如果缺乏对应的类别, 必要时你可以自行创建子文件夹, 目前的 docs/gen 规则详见 @algorithms/NLU/docs/gen/README.md ). 同时, 无论是做规划, 还是之后具体实现代码时, 这里请你注意几点:

1. 新代码的风格应该与旧代码完全保持一致 (必要的注释, 注释可以是中英文混杂的, 但是一定要采用英文标点, 而且中文和英文之前应该用空格隔开; 必要的类型标注, 目前我给 pyright 指定的 type check level 为 standard, 在这个 check level 下, 请你务必保证不要犯低级的类型错误, 一定要写出 lint-error-free 和 bug-free 的代码, 而且尽量避免使用 #type: ignore 这样的注释绕过类型检查来规避错误)
   - pyright typecheck level 详见 @algorithms/NLU/pyrightconfig.json , 也就是说你可以在通过 `./.venv/bin/activate` 激活虚拟环境后, 对实现的代码直接使用 pyright 指令进行 lint, 如果你要在 backend 层面全局使用 pyright, 那么也请你只关注改动或者新实现的代码的相关 lint error 其他的暂时忽略就好.
2. 请你一定要注意, 实现的新功能如无必要请一定不要大改目前的项目架构 (比如说严格遵循 DTO 添加更多 layer), 这只是一个可用性高的 prototype, 不是企业级应用, 不应该让项目本身变得过于臃肿, 应该更务实更敏捷的以现有的架构为基础以直接实现新功能为导向.
3. 如有必要, 请你使用互联网搜索服务获取你想要的相关文档.

接下来我的需求, 一定是围绕着 @algorithms/NLU/ 中已经实现的所有功能 (如你所见, NLU 采用 uv + venv 进行包管理和虚拟环境隔离) 展开的, 即 `基于现有 @algorithms/NLU/ 实现, 追加某些功能, 或是修复某些潜在的 bug`. 因此, 请你在规划或是实现我的需求前, 务必仔细地阅读并理解 @algorithms/NLU/ 中已经实现的所有功能, 并把握其架构设计细节. 由于 NLU 只是一个微服务, 最终实际上由后端服务 backend/ 统一调用, 因此必要时候你可以 checkout 到 dev 分支, 深入阅读并理解 dev 分支中 backend/ 的架构和实现.

## 需求

目前的 @algorithms/NLU/ 的代码质量奇差无比, 存在严重 bug. 最严重的当属 @algorithms/NLU/bug-desc/NLU-ctrlC都没法关闭服务-卡死.png 中展示的问题.

具体而言, RAG 微服务 (@algorithms/RAG_chroma/ ) 每次重新启动首次查询时都需要下载模型文件 (而不是复用已经下载好的模型文件) 导致响应时间超时 (这也是一个 bug, 不过现在请你先不要关注 RAG 实现的 bug), 然后 NLU 服务就会卡住, 这个时候如图所示, 就算使劲按 Ctrl+C 也没办法使得该服务关闭.

请你先在当前分支 (feat/algorithms) 上, 深入理解 @algorithms/NLU/ 的现有架构和实现, 必要时可以在当前分支上理解 @algorithms/RAG_chroma/ 的架构和实现, 或者 checkout 到 dev 分支上理解 backend/ 的架构和实现. 在完成对架构和实现的理解后, 深入分析为什么会产生竟然连服务都没办法关闭的恶性 bug. 同时我有预感, 你不能只针对性的修复这个 bug, 因为这个 bug 很可能只是 NLU 目前实现中存在严重性能开销的不良实践的 `冰山一角`, 因此, 请你务必 `深入分析` 是怎样的不良实践会导致如此严重的性能开销, 以致于连服务都没办法正常关闭了 (后来我用 `lsof -ti :8010 | xargs kill -9` 才得以关闭该服务, 当然如果导致这个 bug 的另有其因, 那么也请你分析出来, 不过不要放弃对现有 NLU 架构实现中可能带来严重性能开销的不良实践的分析). 分析出来问题 (以及会造成严重性能开销的潜在问题) 之后, 请你规划一份修复该 bug 和这些潜在问题的方案.
